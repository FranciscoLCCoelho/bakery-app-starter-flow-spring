<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="login-view">
  <template>
    <style include="shared-styles">

      :host {
        height: 100%;

        /* workaround for a WebKit issue */
        height: 100vh;
        --app-primary-color: var(--valo-primary-color);
        --app-secondary-color: var(--valo-body-text-color);

        display: flex;
        flex-direction: column;
        color: var(--valo-body-text-color);
        font-family: var(--valo-font-family);

        justify-content: center;
      }

      .body {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
      }

      .info {
        background-image: url(../../../images/login-banner.jpg);
        background-size: cover;
        background-position-x: center;
        display: table;
        width: 100%;
        padding: var(--valo-space-l);
      }

      .info__header {
        font-weight: 300;
        color: var(--valo-base-color);
        margin-top: 2em;
        margin-bottom: 0;
      }

      .info__text {
        font-size: var(--valo-font-size-s);
        color: var(--valo-tint-70pct);
        font-weight: 500;
        margin: 0;
      }

      .login {
        padding: var(--valo-space-l);
        background-color: var(--valo-base-color);
        flex: 1;
      }

      .login__header {
        margin-top: 0;
        margin-bottom: 0;
      }

      .login__layout {
        display: flex;
        flex-direction: column;
      }

      .login__layout > * {
        width: 100%;
      }

      .login__button {
        margin-top: var(--valo-space-m);
        margin-left: 0;
        margin-right: 0;
        position: relative;
        min-width: 7em;
      }

      .login__button-icon {
        text-align: right;
        position: absolute;
        right: var(--valo-space-s);
      }

      .error {
        display: flex;
        align-items: flex-start;
      }

      .error__icon {
        flex: 0 0 auto;
        fill: var(--valo-error-color);
        margin-top: 1.3em;
        margin-right: var(--valo-space-s);
      }

      .error__text {
        max-width: 35em;
      }

      @media (min-width: 1000px) {
        .body {
          max-width: 700px;
          height: auto;
          margin: 0 auto;
          box-shadow: 0 2px 5px 0 var(--valo-shade-10pct);
        }

        .info {
          border-top-left-radius: 4px;
          border-top-right-radius: 4px;
        }

        .login {
          border-bottom-left-radius: 4px;
          border-bottom-right-radius: 4px;
          flex: none;
        }

        .login__layout {
          flex-direction: row;
          align-items: flex-end;
        }

        .login__layout > *:not(:first-child) {
          margin-left: var(--valo-space-m);
        }

        .login__button {
          max-width: 7em;
        }

        .login__button-icon {
          position: static;
        }
      }
    </style>
    <div class="body">
      <div class="info">
        <h1 class="info__header">###Bakery###</h1>
        <p class="info__text">
          admin@vaadin.com + admin <br>
          barista@vaadin.com + barista
        </p>
      </div>
      <iron-form class="login" id="form" allow-redirect>
        <form method="post" action="login">
          <h2 class="login__header">Sign in</h2>
          <div class="login__layout">
            <vaadin-text-field id="username" name="username" label="Email" autofocus required></vaadin-text-field>
            <vaadin-password-field id="password" name="password" label="Password" required on-keydown="_onPasswordKeydown"></vaadin-password-field>
            <vaadin-button id="button-submit" class="login__button" on-tap="login" theme="primary">
              Sign In <span class="login__button-icon">â†’</span>
            </vaadin-button>
          </div>
          <template is="dom-if" if="[[error]]">
            <div class="error">
              <iron-icon icon="vaadin:exclamation-circle-o" class="error__icon"></iron-icon>
              <p class="error__text">
                The username and password you entered do not match our records. Please double-check and try again.
              </p>
            </div>
          </template>
        </form>
      </iron-form>
    </div>
  </template>

  <script>
    class BakeryLogin extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'login-view';
      }

      static get properties() {
        return {
          error: {
            type: Boolean,
            value: false
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._measureLoadPerformance();
      }

      // This method is used to measure the page load performance and can be safely removed
      // if there is no need for that.
      _measureLoadPerformance() {
        const banner = new Image();
        banner.onload = () => {
          window.performance.mark('bakery-page-loaded');
        };

        const info = this.shadowRoot.querySelector('.info');
        const cssBackgroundImage = window.getComputedStyle(info).getPropertyValue('background-image');
        const match = cssBackgroundImage.match(/url\("?(.+?)"?\)/i);
        if (match) {
          banner.src = match[1];
        }
      }

      login() {
        if (!this.$.username.invalid && !this.$.password.invalid) {
          this.$.form.submit();
        }
      }

      _onPasswordKeydown(event) {
        if (event.key === 'Enter') {
          this.login();
        }
      }
    }

    window.customElements.define(BakeryLogin.is, BakeryLogin);
  </script>
</dom-module>
