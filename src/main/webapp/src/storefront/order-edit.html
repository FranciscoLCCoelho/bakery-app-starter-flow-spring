<link rel="import" href="../app/style-modules/shared-styles.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/vaadin-themes/valo/icons.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-item.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box-light.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../elements/amount-field.html">
<link rel="import" href="../elements/utils-mixin.html">

<dom-module id="order-edit">
  <template>
 
  </template>
  <script>
    class OrderEdit extends
      window.NotificationMixin(
        window.LocaleUtilsMixin(
          window.ScrollShadowMixin(
            Polymer.Element))) {

      static get is() {
        return 'order-edit';
      }

      static get properties() {
        return {
          item: {
            type: Object,
            value : {}
            // notify: true,
            // observer: '_onItemChange'
          },
          dirty: Boolean,
          products: Array,
          total: Number,
          desktopView: Boolean
        };
      }

      _cancel() {
        this.dispatchEvent(new CustomEvent('cancel', {composed: true}));
      }

      _delete() {
        this.dispatchEvent(new CustomEvent('delete', {composed: true}));
      }

      _onCountChange(e) {
        const idx = e.target.index;
        this.set('item.goods.' + idx + '.count', e.target.value);
      }

      _onDetailChange(e) {
        const idx = e.target.index;
        this.set('item.goods.' + idx + '.description', e.target.value);
      }

      _onTimeChange(e) {
        this.set('item.time', e.target.value);
      }

      _onDateChange(e) {
        this.set('item.date', e.target.value);
      }

      _onStatusChange(e) {
        e.target.$.input.setAttribute('status', e.target.value);
        this.set('item.status', e.target.value);
      }

      _editing(item) {
        return item && !!item._id;
      }

      _onProductChange(e) {
        const idx = e.target.index;
        const prod = e.target.selectedItem;
        this.notifyPath('item.goods.' + idx + '.name', prod.name);
        this.set('item.goods.' + idx + '.unitPrice', prod.price);
        this.set('item.goods.' + idx + '.count', 1);
        if (this.item.goods.length == idx + 1) {
          this.push('item.goods', {});
        }
      }

      _onProductDelete(e) {
        const idx = e.target.index;
        if (this.item.goods.length != idx + 1) {
          this.splice('item.goods', idx, 1);
        }
      }

      _computeTotal() {
        const tot = (this.item && this.item.goods || [])
          .reduce((prev, item) => prev + (item.unitPrice ? item.unitPrice * (item.count || 1) : 0), 0);
        this.set('item.totalPrice', tot);
        return tot ? 'Total ' + this._getCurrency(tot) : '';
      }

      _computeResponsiveSteps(desktopView, desktopColumns, mobileColumns) {
        return [{
          columns: desktopView ? desktopColumns : mobileColumns,
          labelsPosition: 'top'
        }];
      }

      _submitEditForm(e) {
        e.preventDefault();
        return false;
      }

      _getConditional(desktopView, desktopColspan, mobileColspan) {
        return desktopView ? desktopColspan : mobileColspan;
      }

      _review() {
        if (this.$.itemEditForm.validate()) {
          this.dispatchEvent(new CustomEvent('next'));
        } else {
          this.displayToast('Please fill out all required fields before proceeding');
        }
      }
    }

    window.customElements.define(OrderEdit.is, OrderEdit);
  </script>
</dom-module>
