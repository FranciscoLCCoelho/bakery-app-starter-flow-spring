<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="storefront-item-detail.html">
<link rel="import" href="../elements/item-detail-dialog.html">
<link rel="import" href="../elements/utils-mixin.html">
<link rel="import" href="../app/style-modules/shared-styles.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/vaadin-themes/valo/icons.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-item.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box-light.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../elements/amount-field.html">

<dom-module id="order-edit-wrapper">
  <template>
    <div id="wrapper">
      <item-detail-dialog desktop-view$=[[desktopView]] opened="[[opened]]" on-before-close="_onBeforeClose">
   <style include="shared-styles">
      :host {
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        height: 100%;
      }

      .at-icon {
        display: inline-block;
        width: 24px;
        height: 24px;
        font-size: 18px;
        line-height: 24px;
        text-align: center;
      }

      .at-icon::before {
        content: '@';
      }

      .product {
        margin-bottom: 1em;
      }

      .delete {
        min-width: 0;
      }
    </style>
    
    <div class="scrollable flex1" id="main">

      <h2 id="title"></h2>

      <iron-form id="itemEditForm">
        <form on-submit="_submitEditForm">

          <vaadin-form-layout responsive-steps="[[_computeResponsiveSteps(desktopView, 4, 1)]]">
            <vaadin-form-layout responsive-steps='[{"columns": 1, "labelsPosition": "top"}]'>

              <vaadin-combo-box label="Status" id="status">
              </vaadin-combo-box>

              <vaadin-form-item>
                <label slot="label">Due</label>
                <vaadin-form-layout responsive-steps="[[_computeResponsiveSteps(desktopView, 1, 2)]]">
                  <vaadin-date-picker  id="due-date">
                    <iron-icon slot="prefix" icon="valo:calendar"></iron-icon>
                  </vaadin-date-picker>
    
                  <vaadin-combo-box on-change="_onTimeChange" value="[[_getTime(item.time)]]" allow-custom-value items='
                    ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00"]'>
                    <iron-icon slot="prefix" icon="valo:clock"></iron-icon>
                  </vaadin-combo-box>
                </vaadin-form-layout>

              </vaadin-form-item>

              <vaadin-combo-box class="full-width" value="{{item.place}}" items='["Bakery", "Store"]'>
                <div slot="prefix" class="at-icon"></div>
              </vaadin-combo-box>
            </vaadin-form-layout>
    
            <vaadin-form-layout responsive-steps="[[_computeResponsiveSteps(desktopView, 3, 1)]]" colspan="3">

              <vaadin-text-field label="Customer" colspan="2" value="{{item.customer.name}}"
                required>
                <iron-icon slot="prefix" icon="valo:user"></iron-icon>
              </vaadin-text-field>
    
              <vaadin-text-field label="Phone number" value="{{item.customer.number}}" required>
                <iron-icon slot="prefix" icon="valo:phone"></iron-icon>
              </vaadin-text-field>
    
              <vaadin-text-field label="Aditional Details" value="{{item.customer.details}}" colspan="2"></vaadin-text-field>
    
              <vaadin-form-item colspan="3">
                <label slot="label">Products</label>
    
                <template is="dom-repeat" items="[[item.goods]]" as="product">
                  <vaadin-form-layout class="product" responsive-steps="[[_computeResponsiveSteps(desktopView, 18, 10)]]">
                    <vaadin-combo-box colspan="8"value="{{product.name}}" items="[[products]]"
                      item-label-path="name" item-value-path="name"
                      on-change="_onProductChange" allow-custom-value index="[[index]]"></vaadin-combo-box>
    
                    <vaadin-button colspan="2" class="delete" index="[[index]]" on-click="_onProductDelete"
                      theme="narrow" style$="order: [[_getConditional(desktopView, 2, 0)]];">✕</vaadin-button>
    
                    <amount-field colspan="4" value="{{product.count}}"
                      min="1" max="15" on-value-changed="_onCountChange" index="[[index]]"
                      style="order: 1"></amount-field>
    
                    <div colspan="4" class="money"
                      style="order: 1">[[_getCurrency(product.unitPrice)]]</div>
    
                    <vaadin-text-field colspan$="[[_getConditional(desktopView, 12, 8)]]" placeholder="Details"
                      on-value-changed="_onDetailChange" value="{{product.description}}" index="[[index]]"
                      style="order: 3"></vaadin-text-field>
                  </vaadin-form-layout>
                </template>
              </vaadin-form-item>

            </vaadin-form-layout>
          </vaadin-form-layout>
        </form>
      </iron-form>
    </div>

    <div class="footer">
      <vaadin-button on-click="_cancel">Cancel</vaadin-button>
      <!-- <div class="total money">[[_computeTotal(item.goods.*)]]</div> -->
      <vaadin-button on-click="_review" theme="primary" disabled="[[!dirty]]">Review Order →</vaadin-button>
    </div>
        <storefront-item-detail hidden$="[[!review]]" review item="{{editableItem}}" on-back="_edit" ></storefront-item-detail>
      </item-detail-dialog>
    </div>  
  </template>

  <script>
    class OrderEditWrapper extends window.EditableItemMixin( window.NotificationMixin(
            window.LocaleUtilsMixin(
                    window.ScrollShadowMixin(
                      Polymer.Element)))) {
      static get is() {
        return 'order-edit-wrapper';
      }

      static get properties() {
        return {
          opened: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          desktopView: {
            type: Boolean
          },
          review: Boolean
        };
      }

      ready() {
        super.ready();
        this.addEventListener('close', () => this.item = null);
      }

      _onItemChanged(item) {
        super._onItemChanged(item);
        this.opened = !!item;
        this.review = false;

        // Hack: Editor modifies the editableItem, we need to update the _originalItemString with the changes
        setTimeout(() => {
          this._originalItemString = JSON.stringify(this.editableItem);
          this._checkDirty();
        }, 10);
      }

      _review() {
        this.review = true;
      }

      _edit() {
        this.review = false;
      }

      _onBeforeClose(e) {
        if (this.dirty) {
          e.preventDefault();
        }
      }
    }

    window.customElements.define(OrderEditWrapper.is, OrderEditWrapper);
  </script>
</dom-module>
