<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="vaadin-modal-dialog-styles">
  <template>
    <style>
      :host,
      #back,
      #fore {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 200;
      }

      #fore {
        background: white;
        overflow: hidden;
      }

      :host([desktop-view]) #fore {
        border-radius: 5px;
      }

      #back {
        background: var(--valo-shade-20pct);
      }
    </style>
  </template>
</dom-module>

  <script>
    /**
     * Adds listeners to body for closing the element on click and escape.
     * It sends a `closed` or `opened` event up when the element changes the status.
     */
    /* @polymerMixin */
    window.CloseableDialogMixin = subclass => class extends subclass {
      static get properties() {
        return {
          opened: {
            type: Boolean,
            reflectToAttribute: true,
            observer: '_onOpened',
            notify: true,
            value: false
          }
        };
      }

      ready() {
        super.ready();
        this._clickListener = this._onBodyClick.bind(this);
        this._keydownListener = this._onBodyKeydown.bind(this);
        this._closeListener = this.close.bind(this);

        this.addEventListener('click', e => e.stopPropagation());
      }

      _onOpened(opened, old) {
        if (opened === true) {
          setTimeout(() => {
            document.body.addEventListener('click', this._clickListener);
            document.body.addEventListener('keydown', this._keydownListener);
            this.addEventListener('close', this._closeListener);
          }, 2);
        } else {
          document.body.removeEventListener('click', this._clickListener);
          document.body.removeEventListener('keydown', this._keydownListener);
          this.removeEventListener('close', this._closeListener);
        }
        this.style.display = opened ? 'block' : 'none';
        if (old === undefined) {
          return;
        }
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.dispatchEvent(new CustomEvent(opened ? 'opened' : 'closed', {bubbles: true, composed: true}));
        });
      }

      _onBodyClick(e) {
        if (e.composedPath().indexOf(this) < 0) {
          this.close();
        }
      }

      _onBodyKeydown(e) {
        if (e.keyCode == 27) {
          this.close();
        }
      }

      close(e) {
        // When sending the event, the component might be attached to the body instead of to
        // its original place, so we don't want to bubble.
        // It's the user responsibility to forward this event up.
        const customEvent = new CustomEvent('before-close', {composed: true, cancelable: true});
        this.dispatchEvent(customEvent);
        if (!customEvent.defaultPrevented) {
          this.opened = false;
        }
      }
    };
  </script>
</dom-module>
