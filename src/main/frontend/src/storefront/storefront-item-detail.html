<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../elements/utils-mixin.html">

<link rel="import" href="storefront-item-badge.html">

<dom-module id="storefront-item-detail">
  <template>
    <style include="shared-styles">
       :host {
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        height: 100%;
      }

      h3 {
        margin: 0;
      }

      .secondary {
        color: var(--valo-secondary-text-color);
        font-size: var(--valo-font-size-xs);
      }

      .meta-row {
        justify-content: space-between;
        width: 100%;
        padding-bottom: var(--valo-space-s);
      }

      .date-wrapper,
      .name-row,
      .contact-row {
        margin-bottom: var(--valo-space-m);
      }

      .date {
        margin-right: var(--valo-space-m);
      }

      .product-row {
        justify-content: space-between;
        flex: 1;
        border-bottom: 1px solid var(--valo-contrast-10pct);
      }

      .space-top {
        margin-top: var(--valo-space-m);
      }

      .count {
        background: var(--valo-shade-10pct);
        border-radius: var(--valo-border-radius);
        width: 20px;
        height: 20px;
        font-size: var(--valo-font-size-s);
        text-align: center;
      }

      .comment {
        font-size: var(--valo-font-size-s);
      }

      @media (min-width: 600px) {
        .bottom-row {
          height: auto;
        }

        .main-row {
          padding: var(--valo-space-l);
          height: auto;
          max-height: 600px;
        }

        .date-wrapper,
        .name-row,
        .contact-row {
          margin-bottom: 0;
        }
      }
    </style>

    <div class="scrollable flex1 main-row" id="main">
      <div class="flex meta-row">
        <storefront-item-badge status="[[item.status]]"></storefront-item-badge>
        <span class="secondary">Order #[[item.orderNumber]]</span>
      </div>
      <div class="flex column">
        <div class="flex">
          <div class="flex column flex2 date-wrapper">
            <span class="secondary">Due</span>
            <div class="flex date-row">
              <div class="flex date column">
                <h3>[[_getDay(item.date)]]</h3>
                <span class="secondary">[[_getWeekday(item.date)]]</span>
              </div>
              <div class="flex column">
                <h3>[[_getTime(item.time)]]</h3>
                <span class="secondary">[[item.place]]</span>
              </div>
            </div>
          </div>
          <div class="name-row flex5">
            <span class="secondary">Customer</span>
            <h3>[[item.customer.name]]</h3>
          </div>
          <div class="contact-row flex2">
            <span class="secondary">Phone number</span>
            <h3>[[item.customer.number]]</h3>
          </div>
        </div>
        <div class="flex customer-info-row">
          <div class="flex2">
          </div>
          <div class="flex column flex5">
            <span class="secondary">Additional details</span>
            <span>[[item.customer.details]]</span>
            <span class="secondary space-top">Products</span>
            <div class="flex column">
              <template is="dom-repeat" items="[[item.goods]]" as="product">
                <template is="dom-if" if="[[product.name]]">
                  <div class="flex product-row align-center">
                    <div class="flex column flex9">
                      <span class="bold">[[product.name]]</span>
                      <span class="secondary">[[product.description]]</span>
                    </div>
                    <div class="flex justify-center align-center flex1">
                      <div class="count">
                        [[product.count]]
                      </div>
                    </div>
                    <div class="flex justify-center secondary flex1">
                      x
                    </div>
                    <div class="flex1 money">
                      [[_getCurrency(product.unitPrice)]]
                    </div>
                  </div>
                </template>
              </template>
            </div>
            <template is="dom-if" if="[[!review]]">
              <span class="secondary space-top">History</span>
              <div class="flex column">
                <template is="dom-repeat" items="[[item.history]]" as="event">
                  <div>
                    <span class="bold">[[event.name]]</span>
                    <span class="secondary">[[_getFullDate(event.date)]]</span>
                    <storefront-item-badge status="[[event.status]]" small></storefront-item-badge>
                  </div>
                </template>
              </div>
              <div class="flex column space-top">
                <template is="dom-repeat" items="[[item.comments]]" as="comment">
                  <span class="comment">[[comment.message]]</span>
                </template>
              </div>
              <vaadin-text-field placeholder="Add comment" class="space-top">
                <div slot="suffix" class="comment-suffix">Send</div>
              </vaadin-text-field>
            </template>
          </div>
          <div class="flex2">
          </div>
        </div>
      </div>
    </div>
    <div class="flex footer">
      <vaadin-button on-click="_cancel">[[_cancelText()]]</vaadin-button>
      <div class="total money">Total [[_getCurrency(item.totalPrice)]]</div>
      <template is="dom-if" if="[[review]]">
        <vaadin-button theme="primary success" class="edit-button" on-click="_save">Place Order âœ“</vaadin-button>
      </template>
      <template is="dom-if" if="[[!review]]">
        <vaadin-button theme="primary icon" class="edit-button" on-click="_edit">
          <span>Edit order</span>
          <iron-icon icon="valo:edit"></iron-icon>
        </vaadin-button>
      </template>
    </div>
  </template>

  <script>
    class StorefrontItemDetail extends window.DateUtilsMixin(window.ScrollShadowMixin(Polymer.Element)) {
      static get is() {
        return 'storefront-item-detail';
      }

      static get properties() {
        return {
          item: {
            type: Object
          },
          review: {
            type: Boolean,
            value: false
          }
        };
      }

      close() {
        this.dispatchEvent(new CustomEvent('close', {bubbles: true, composed: true}));
      }

      _edit() {
        this._do('edit', this._deepCopy(this.item));
      }

      _save() {
        this._do('save', this.item);
      }

      _do(type, localItem) {
        this.close();
        Polymer.RenderStatus.afterNextRender(this, () =>
          this.dispatchEvent(new CustomEvent(type, {bubbles: true, composed: true, detail: localItem})));
      }

      _deepCopy(obj) {
        var copy;

        if (null == obj || 'object' != typeof obj) {
          return obj;
        }

        if (obj instanceof Date) {
          copy = new Date();
          copy.setTime(obj.getTime());
          return copy;
        }

        if (obj instanceof Array) {
          copy = [];
          for (var i = 0, len = obj.length; i < len; i++) {
            copy[i] = this._deepCopy(obj[i]);
          }
          return copy;
        }

        if (obj instanceof Object) {
          copy = {};
          for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) {
              copy[attr] = this._deepCopy(obj[attr]);
            }
          }
          return copy;
        }

        throw new Error('Unable to copy obj! Its type isn\'t supported.');
      }

      _cancelText() {
        return this.review ? 'Back' : 'Close';
      }

      _cancel() {
        if (this.review) {
          this.dispatchEvent(new CustomEvent('back'));
        } else {
          this.close();
        }
      }
    }

    window.customElements.define(StorefrontItemDetail.is, StorefrontItemDetail);
  </script>
</dom-module>
