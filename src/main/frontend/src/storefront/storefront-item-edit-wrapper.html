<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="storefront-item-edit.html">
<link rel="import" href="storefront-item-detail.html">
<link rel="import" href="../elements/item-detail-dialog.html">
<link rel="import" href="../elements/utils-mixin.html">

<dom-module id="storefront-item-edit-wrapper">
  <template>
    <div id="wrapper">
      <item-detail-dialog desktop-view$=[[desktopView]] opened="[[opened]]" on-before-close="_onBeforeClose">
        <storefront-item-edit desktop-view="[[desktopView]]" hidden$="[[review]]"
          item="{{_editableItem}}"
          on-next="_review"
          on-cancel="cancel"
          on-delete="delete"
          dirty="[[dirty]]"
          products="[[products]]"
          ></storefront-item-edit>
        <storefront-item-detail hidden$="[[!review]]" review item="{{_editableItem}}" on-back="_edit" ></storefront-item-detail>
      </item-detail-dialog>
    </div>
  </template>

  <script>
    class StoreFromItemEditEditWrapper extends window.EditableItemMixin(Polymer.Element) {
      static get is() {
        return 'storefront-item-edit-wrapper';
      }

      static get properties() {
        return {
          opened: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          desktopView: {
            type: Boolean
          },
          review: Boolean
        };
      }

      ready() {
        super.ready();
        this.addEventListener('close', () => this.item = null);
      }

      _onItemChanged(item) {
        super._onItemChanged(item);
        this.opened = !!item;
        this.review = false;

        // Hack: Editor modifies the _editableItem, we need to update the _originalItemString with the changes
        setTimeout(() => {
          this._originalItemString = JSON.stringify(this._editableItem);
          this._checkDirty();
        }, 10);
      }

      _review() {
        this.review = true;
      }

      _edit() {
        this.review = false;
      }

      _onBeforeClose(e) {
        if (this.dirty) {
          e.preventDefault();
        }
      }
    }

    window.customElements.define(StoreFromItemEditEditWrapper.is, StoreFromItemEditEditWrapper);
  </script>
</dom-module>
